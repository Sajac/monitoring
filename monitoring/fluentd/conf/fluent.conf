<source>
  @type tail
  path /var/lib/docker/containers/*/*.log
  pos_file /fluentd/log/docker-containers.pos
  tag docker.*
  format json
  time_key time
  time_format %Y-%m-%dT%H:%M:%S.%NZ
  read_from_head true
</source>

<filter docker.**>
  @type parser
  key log
  reserve_data true
  format json
</filter>

<filter docker.**>
  @type record_transformer
  enable_ruby true
  <record>
    container_id ${tag_parts[1]}
    container_name ${record["container_name"] || record["CONTAINER_NAME"] || record["kubernetes"]["container_name"] || "unknown"}
  </record>
</filter>

<filter docker.**>
  @type rewrite_tag_filter
  <rule>
    key container_name
    pattern /(.*)/
    tag container_logs.$1
  </rule>
</filter>

<match container_logs.**>
  @type file
  path /var/log/containers/${tag_parts[1]}.log
  time_slice_format %Y%m%d
  time_slice_wait 10m
  compress text
  append true
  <buffer time>
    timekey 86400
    timekey_wait 10m
    flush_at_shutdown true
  </buffer>
  <format>
    @type json
  </format>
</match>

# Метрики Prometheus
<source>
  @type prometheus
  bind 0.0.0.0
  port 24220
</source>

<match fluent.**>
  @type prometheus
</match>
