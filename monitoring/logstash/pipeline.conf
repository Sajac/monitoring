input {
  # Вход для логов Docker контейнеров
  gelf {
    port => 12201
  }
  
  # Или использовать файловый ввод для логов из /var/log
  file {
    path => "/var/log/containers/*.log"
    start_position => "beginning"
    sincedb_path => "/dev/null"
  }
}

filter {
  # Добавляем timestamp к имени файла
  mutate {
    add_field => {
      "log_file" => "/var/log/logstash/%{[container][name]}_%{+YYYY-MM-dd_HH-mm}.log"
    }
  }
  
  # Дополнительная обработка логов (при необходимости)
  grok {
    match => { "message" => "%{TIMESTAMP_ISO8601:timestamp} %{LOGLEVEL:loglevel} %{GREEDYDATA:message}" }
  }
  
  date {
    match => [ "timestamp", "ISO8601" ]
  }
}

output {
  # Сохраняем логи в файлы
  file {
    path => "/var/log/logstash/%{[container][name]}_%{+YYYY-MM-dd_HH-mm}.log"
    codec => line { format => "%{message}" }
  }
  
  # Также отправляем метрики в Prometheus
  if [metric_name] {
    http {
      url => "http://prometheus:9090/api/v1/import/prometheus"
      http_method => "post"
      format => "message"
      content_type => "text/plain"
      message => '%{[metric_name]} %{[metric_value]}'
    }
  }
  
  # Для отладки
  stdout {
    codec => rubydebug
  }
}